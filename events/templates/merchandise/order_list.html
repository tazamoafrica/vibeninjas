{% extends 'merchandise/base_merchandise.html' %}
{% load humanize %}
{% load static %}

{% block merchandise_title %}My Orders - TazamoEXP{% endblock %}

{% block page_title %}
<div class="mt-5">
    <i class="bi bi-bag-check me-2"></i>My Orders
</div>
{% endblock %}

{% block page_subtitle %}
    <i class="bi {% if is_seller_view %}bi-shop{% else %}bi-clock-history{% endif %} me-1"></i>
    {% if is_seller_view %}Orders for your merchandise{% else %}Your order history{% endif %}
{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-decoration-none"><i class="bi bi-house-door"></i> Home</a></li>
    <li class="breadcrumb-item active" aria-current="page"><i class="bi bi-bag-check"></i> My Orders</li>
{% endblock %}

{% block merchandise_content %}
<div class="card shadow-sm border-0">
    <div class="card-header bg-white border-bottom d-flex flex-column flex-md-row justify-content-between align-items-md-center">
        <h5 class="mb-2 mb-md-0 d-flex align-items-center">
            {% if is_seller_view %}
                <i class="bi bi-shop me-2 text-primary"></i> Orders for Your Merchandise
            {% else %}
                <i class="bi bi-clock-history me-2 text-primary"></i> Your Order History
            {% endif %}
        </h5>
        
        <div class="d-flex mt-2 mt-md-0">
            <div class="input-group input-group-sm" style="max-width: 300px;">
                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                <input type="text" class="form-control border-start-0" id="search-orders" placeholder="Search orders...">
                <button class="btn btn-outline-secondary" type="button"><i class="bi bi-funnel"></i></button>
            </div>
        </div>
    </div>
    
    <div class="card-body p-0">
        {% if orders %}
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-3"><i class="bi bi-hash me-1"></i> Order #</th>
                        <th><i class="bi bi-calendar3 me-1"></i> Date</th>
                        {% if is_seller_view %}
                        <th><i class="bi bi-person me-1"></i> Customer</th>
                        {% else %}
                        <th><i class="bi bi-box-seam me-1"></i> Items</th>
                        {% endif %}
                        <th><i class="bi bi-cash-coin me-1"></i> Total</th>
                        <th><i class="bi bi-info-circle me-1"></i> Status</th>
                        <th class="text-end pe-3"><i class="bi bi-activity"></i> Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr class="order-row align-middle">
                        <td class="ps-3">
                            <a href="{% url 'merchandise_order_detail' order.id %}" class="text-decoration-none fw-medium d-flex align-items-center">
                                <i class="bi bi-file-earmark-text me-2 text-primary"></i>
                                #{{ order.order_number }}
                            </a>
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <span>{{ order.created_at|date:"M d, Y" }}</span>
                                <small class="text-muted">{{ order.created_at|time:"h:i A" }}</small>
                            </div>
                        </td>
                        
                        {% if is_seller_view %}
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm me-2 bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center rounded-circle" style="width: 32px; height: 32px;">
                                    <i class="bi bi-person"></i>
                                </div>
                                <div>
                                    <div class="fw-medium">{{ order.first_name }} {{ order.last_name }}</div>
                                    <small class="text-muted">{{ order.email|truncatechars:20 }}</small>
                                </div>
                            </div>
                        </td>
                        {% else %}
                        <td>
                            {% with order.items.first as first_item %}
                                {% if first_item %}
                                    <div class="d-flex align-items-center">
                                        {% with first_item.merchandise as merch %}
                                            {% if merch.image and merch.image.url %}
                                                {% static 'img/default-product.png' as default_image %}
                                                <img src="{{ merch.image.url }}" 
                                                     alt="{{ merch.name }}" 
                                                     class="rounded me-2" 
                                                     style="width: 40px; height: 40px; object-fit: cover;" 
                                                     onerror="this.onerror=null; this.src='{{ default_image }}';" 
                                                     onload="this.style.display='inline-block';" />
                                            {% else %}
                                            <div class="rounded me-2 d-flex align-items-center justify-content-center bg-light" 
                                                 style="width: 40px; height: 40px; color: #6c757d;">
                                                <i class="bi bi-box-seam"></i>
                                            </div>
                                            {% endif %}
                                            <div>
                                                <div class="fw-medium">{{ merch.name|truncatechars:30 }}</div>
                                                {% if order.items.count > 1 %}
                                                    <small class="text-muted">+{{ order.items.count|add:"-1" }} more item{{ order.items.count|add:"-1"|pluralize }}</small>
                                                {% endif %}
                                            </div>
                                        {% endwith %}
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </td>
                        {% endif %}
                        
                        <td class="fw-semibold">
                            <i class="bi bi-currency-exchange me-1"></i>Ksh. {{ order.get_total_cost_with_shipping|floatformat:2|intcomma }}
                        </td>
                        
                        <td>
                            {% with status_icon=order.status|lower %}
                            <span class="badge d-inline-flex align-items-center py-2 px-3 rounded-pill status-badge status-{{ status_icon }}">
                                <i class="bi me-1 
                                    {% if status_icon == 'pending' %}bi-hourglass-split
                                    {% elif status_icon == 'processing' %}bi-arrow-repeat
                                    {% elif status_icon == 'shipped' %}bi-truck
                                    {% elif status_icon == 'delivered' %}bi-check-circle
                                    {% elif status_icon == 'cancelled' %}bi-x-circle
                                    {% else %}bi-info-circle{% endif %}
                                "></i>
                                {{ order.get_status_display }}
                            </span>
                            {% endwith %}
                            
                            {% if order.payment_method == 'mpesa' and not order.paid %}
                            <div class="d-flex align-items-center mt-1">
                                <div class="progress flex-grow-1 me-2" style="height: 4px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                                         role="progressbar" style="width: 100%" 
                                         aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <small class="text-muted"><i class="bi bi-hourglass-split me-1"></i>Processing payment...</small>
                            </div>
                            {% endif %}
                        </td>
                        
                        <td class="text-end pe-3">
                            <a href="{% url 'merchandise_order_detail' order.id %}" 
                               class="btn btn-sm btn-outline-primary d-inline-flex align-items-center"
                               data-bs-toggle="tooltip" data-bs-placement="top" title="View order details">
                                <i class="bi bi-eye me-1"></i> View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if is_paginated %}
        <nav aria-label="Page navigation" class="mt-4 px-3">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1" aria-label="First">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active">
                        <a class="page-link" href="#">{{ num }}</a>
                    </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                    {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Last">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        
        {% else %}
        <div class="text-center p-5">
            <div class="mb-4">
                <i class="bi bi-cart-x text-muted" style="font-size: 3rem; opacity: 0.5;"></i>
            </div>
            <h5>No Orders Found</h5>
            <p class="text-muted">
                {% if is_seller_view %}
                    You haven't received any orders for your merchandise yet.
                {% else %}
                    You haven't placed any orders yet. Start shopping to see your orders here.
                {% endif %}
            </p>
            <a href="{% url 'merchandise_list' %}" class="btn btn-primary mt-3">
                <i class="bi bi-shop me-2"></i> Browse Merchandise
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Order Status Legend -->
<div class="card shadow-sm mt-4">
    <div class="card-header bg-light">
        <h6 class="mb-0">Order Status Legend</h6>
    </div>
    <div class="card-body py-2">
        <div class="row g-3">
            <div class="col-6 col-md-3">
                <div class="d-flex align-items-center">
                    <span class="badge status-badge status-pending me-2">Pending</span>
                    <small class="text-muted">Order received, not yet processed</small>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="d-flex align-items-center">
                    <span class="badge status-badge status-processing me-2">Processing</span>
                    <small class="text-muted">Order is being prepared</small>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="d-flex align-items-center">
                    <span class="badge status-badge status-shipped me-2">Shipped</span>
                    <small class="text-muted">Order is on its way</small>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="d-flex align-items-center">
                    <span class="badge status-badge status-delivered me-2">Delivered</span>
                    <small class="text-muted">Order has been delivered</small>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="d-flex align-items-center">
                    <span class="badge status-badge status-cancelled me-2">Cancelled</span>
                    <small class="text-muted">Order was cancelled</small>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="d-flex align-items-center">
                    <span class="badge status-badge status-refunded me-2">Refunded</span>
                    <small class="text-muted">Order was refunded</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Status badges */
    .status-badge {
        font-weight: 500;
        text-transform: capitalize;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        padding: 0.35rem 0.75rem;
    }
    
    .status-pending {
        background-color: #fff3e6;
        color: #e67e22;
        border-left: 3px solid #e67e22;
    }
    
    .status-processing {
        background-color: #e3f2fd;
        color: #1976d2;
        border-left: 3px solid #1976d2;
    }
    
    .status-shipped {
        background-color: #e8f5e9;
        color: #388e3c;
        border-left: 3px solid #388e3c;
    }
    
    .status-delivered {
        background-color: #e8f5e9;
        color: #2e7d32;
        border-left: 3px solid #2e7d32;
    }
    
    .status-cancelled {
        background-color: #ffebee;
        color: #d32f2f;
        border-left: 3px solid #d32f2f;
    }
    
    .order-row {
        transition: all 0.2s ease;
    }
    
    .order-row:hover {
        background-color: #f8f9fa;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .order-row td {
        transition: all 0.2s ease;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .avatar-sm {
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 0.875rem;
    }
    
    .table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.5px;
        color: #6c757d;
        padding: 0.75rem;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }
    
    .table td {
        vertical-align: middle;
        padding: 1rem 0.75rem;
    }
    
    .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        transition: all 0.3s ease;
        border-bottom: 1px solid #dee2e6;
    }
    
    .table td:last-child {
        border-bottom: none;
    }
    
    .table td::before {
        content: attr(data-label);
        font-weight: 500;
        margin-right: 1rem;
        color: #6c757d;
    }
    
    .table td:last-child {
        justify-content: flex-end;
    }
    
    /* Responsive adjustments */
    @media (max-width: 767.98px) {
        .table th, .table td {
            padding: 0.5rem;
            font-size: 0.85rem;
        }
        
        .status-badge {
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .table td {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Hide the actions label on mobile */
        .table td[data-label="Actions"]::before {
            display: none;
        }
    }

    /* Ensure all icons are properly displayed */
.bi {
    display: inline-block;
    vertical-align: -0.125em;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('search-orders');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('.order-row');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
    
    // Make entire row clickable
    const orderRows = document.querySelectorAll('.order-row');
    orderRows.forEach(row => {
        const link = row.querySelector('a[href]');
        if (link) {
            row.addEventListener('click', function(e) {
                // Don't navigate if clicking on a button or link
                if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.closest('a') || e.target.closest('button')) {
                    return;
                }
                window.location.href = link.href;
            });
            
            // Add hover effect
            row.style.cursor = 'pointer';
        });
    });
    
    // Check for pending M-Pesa payments
    {% for order in orders %}
        {% if order.payment_method == 'mpesa' and not order.paid %}
        (function() {
            const orderId = {{ order.id }};
            let checkCount = 0;
            const maxChecks = 10;
            const checkInterval = 5000; // 5 seconds
            
            function checkPaymentStatus() {
                if (checkCount >= maxChecks) {
                    console.log('Max payment status checks reached for order', orderId);
                    return;
                }
                
                fetch(`/api/merchandise/orders/${orderId}/status/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.paid) {
                            // Payment successful, reload the page to show updated status
                            window.location.reload();
                        } else {
                            // Check again after delay
                            checkCount++;
                            if (checkCount < maxChecks) {
                                setTimeout(checkPaymentStatus, checkInterval);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error checking payment status:', error);
                        checkCount++;
                        if (checkCount < maxChecks) {
                            setTimeout(checkPaymentStatus, checkInterval);
                        }
                    });
            }
            
            // Start checking payment status after a short delay
            setTimeout(checkPaymentStatus, 2000);
        })();
        {% endif %}
    {% endfor %}
});
</script>
{% endblock %}